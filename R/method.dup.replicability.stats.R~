library(openxlsx)
library(tidyr)
library(stringr)
library(stringi)
library(reshape2)
library(gplots)
library(RColorBrewer)
#--------------------------------------------------------------------------------------
#' Compare pairs of duplicated chemical / signatures to see what parameter
#' drive replicability
#' @param method signature scoring method in c("fc", "gsva", "mygsea")
#'
#'
#' Error bars are exp(er)*qt(.025,4) = exp(er)*2.7765
#' heparg2d_toxcast_pfas_pe1_normal
#' mcf7_ph1_pe1_normal_good_pg
#' u2os_meanncnt0_5-plateteffect_1-shrinkage_normal
#--------------------------------------------------------------------------------------
method.dup.replicability.stats <- function(to.file=F,
                                           do.load=F,
                                           do.prep=F,
                                           dataset="mcf7_ph1_pe1_normal_good_pg",
                                           sigset="screen_large") {
  printCurrentFunction(paste(dataset,sigset))
  if(to.file) {
    fname <- paste0("../output/signature_replicability/method.dup.replicability.stats ",dataset,"_",sigset,".pdf")
    pdf(file=fname,width=8,height=10,pointsize=12,bg="white",paper="letter",pagecentre=T)
  }
  par(mfrow=c(3,2),mar=c(4,4,2,2))

  if(do.load) {
    cat("   do.load\n")

    file <- paste0("../output/signature_conc_resp_summary/SIGNATURE_CR_",sigset,"_",dataset,"_mygsea_0.05_conthits.RData")
    print(file)
    load(file=file)
    scr1 <- SIGNATURE_CR
    scr1[is.na(scr1$super_target),"super_target"] <- "-"
    scr1 <- scr1[!is.element(scr1$super_target,"-"),]
    rn1 <- paste0(scr1$sample_id,"_",scr1$signature)
    rownames(scr1) <- rn1

    file <- paste0("../output/signature_conc_resp_summary/SIGNATURE_CR_",sigset,"_",dataset,"_fc_0.05_conthits.RData")
    print(file)
    load(file=file)
    scr2 <- SIGNATURE_CR
    scr2[is.na(scr2$super_target),"super_target"] <- "-"
    scr2 <- scr2[!is.element(scr2$super_target,"-"),]
    rn2 <- paste0(scr2$sample_id,"_",scr2$signature)
    rownames(scr2) <- rn2

    rn <- rn1[is.element(rn1,rn2)]
    rn <- rn[is.element(rn,rn1)]
    SCR1 <- scr1[rn,]
    SCR2 <- scr2[rn,]
  }
  if(do.prep) {
    cat("  do.prep 1\n")
    scr1 <- SCR1[1:1000,]
    scr2 <- SCR2[1:1000,]
    res <- cbind(scr1[c("dtxsid","casrn","name","signature",
                        "sample_id","top_over_cutoff","hitcall","bmd","top")],
                 scr2[c("sample_id","top_over_cutoff","hitcall","bmd","top")])
    name.list <- c("dtxsid","casrn","name","signature",
                   "sid1","tc1","hc1","bmd1","top1",
                   "sid2","tc2","hc2","bmd2","top2")
    names(res) <- name.list

    cat("  do.prep 2\n")
    res$delta_bmd <- abs(log10(res$bmd1)-log10(res$bmd2))
    delta_tsign <- res$top1/abs(res$top1) - res$top2/abs(res$top2)
    delta_tsign <- -abs(delta_tsign)/2
    delta_tsign[delta_tsign==0] <- 1
    res$delta_top <- delta_tsign * abs(res$top1-res$top2)

    cat("  do.prep 3\n")
    res[is.na(res$tc1),"tc1"] <- 0
    res[is.na(res$tc2),"tc2"] <- 0
    res[is.na(res$hc1),"hc1"] <- 0
    res[is.na(res$hc2),"hc2"] <- 0

    cat("  do.prep 4\n")
    res$max_tc <- res$tc1
    res[res$tc2>res$tc1,"max_tc"] <- res[res$tc2>res$tc1,"tc2"]

    res$max_hc <- res$hc1
    res[res$hc2>res$hc1,"max_hc"] <- res[res$hc2>res$hc1,"hc2"]

    cat("  do.prep 5\n")

    RES <<- res
    cat("  do.prep 6\n")

    file <- paste0("../output/signature_replicability/method.dup.replicability.stats ",dataset,"_",sigset,".RData")
    save(RES,file=file)
    cat("  do.prep 9\n")
  }
  res <- RES
  if(!to.file) browser()
  hc.list <- c(0.5,0.6,0.7,0.8,0.9)
  x <- NULL
  y <- NULL
  for(hc in hc.list) {
    dbmd <- res[res$max_hc>hc,"delta_bmd"]
    temp <- vector(length=length(dbmd),mode="character")
    temp[] <- paste0(">",hc)
    x <- c(x,temp)
    y <- c(y,dbmd)
  }
  boxplot(y~x,main="delta(bmd)~HC",ylim=c(0,4),xlab="HC Cutoff",ylab="delta log(BMD)")

  x <- NULL
  y <- NULL
  for(hc in hc.list) {
    dbmd <- res[res$max_hc>hc,"delta_top"]
    temp <- vector(length=length(dbmd),mode="character")
    temp[] <- paste0(">",hc)
    x <- c(x,temp)
    y <- c(y,dbmd)
  }
  boxplot(y~x,main="delta(top)~HC",ylim=c(-1,1),xlab="HC Cutoff",ylab="delta log(Top)")
  #####################################################################################

  res <- res[res$max_hc>0.8,]
  tc.list <- seq(from=1.0,to=4.0,by=0.5)
  x <- NULL
  y <- NULL
  for(tc in tc.list) {
    dbmd <- res[res$max_tc>tc,"delta_bmd"]
    temp <- vector(length=length(dbmd),mode="character")
    temp[] <- paste0(">",tc)
    x <- c(x,temp)
    y <- c(y,dbmd)
  }
  boxplot(y~x,main="delta(bmd)~TC",ylim=c(0,4),xlab="TC Cutoff",ylab="delta log(BMD)")

  x <- NULL
  y <- NULL
  for(tc in tc.list) {
    dbmd <- res[res$max_tc>tc,"delta_top"]
    temp <- vector(length=length(dbmd),mode="character")
    temp[] <- paste0(">",tc)
    x <- c(x,temp)
    y <- c(y,dbmd)
  }
  boxplot(y~x,main="delta(top)~TC",ylim=c(-1,1),xlab="TC Cutoff",ylab="delta log(Top)")

  ################################################################################
  res <- res[res$max_tc>2,]
  ec.list <- seq(from=0,to=10,by=2)
  x <- NULL
  y <- NULL
  for(ec in ec.list) {
    dbmd <- res[res$max_ec<ec,"delta_bmd"]
    temp <- vector(length=length(dbmd),mode="character")
    temp[] <- paste0("<",ec)
    x <- c(x,temp)
    y <- c(y,dbmd)
  }
  boxplot(y~x,main="delta(bmd)~EC",ylim=c(0,4),xlab="EC Cutoff",ylab="delta log(BMD)")

  x <- NULL
  y <- NULL
  for(ec in ec.list) {
    dbmd <- res[res$max_ec<ec,"delta_top"]
    temp <- vector(length=length(dbmd),mode="character")
    temp[] <- paste0("<",ec)
    x <- c(x,temp)
    y <- c(y,dbmd)
  }
  boxplot(y~x,main="delta(top)~EC",ylim=c(-1,1),xlab="EC Cutoff",ylab="delta log(Top)")

  if(!to.file) browser()
  ####################################################################
  cat("  do cr plots 1\n")
  par(mfrow=c(3,2),mar=c(4,4,2,2))
  res <- RES

  res <- res[order(res$max_tc,decreasing=T),]
  mask <- vector(mode="integer",length=nrow(res))
  mask[] <- 0
  mask1 <- mask;mask2 <- mask
  mask1[res$tc1>2] <- 1
  mask2[res$tc2>2] <- 1
  mask12 <- mask1+mask2
  res <- res[mask12>0,]
  cat("  do cr plots 2a:",nrow(res),"\n")

  mask <- vector(mode="integer",length=nrow(res))
  mask1 <- mask;mask2 <- mask
  mask1[res$hc1>0.7] <- 1
  mask2[res$hc2>0.7] <- 1
  mask12 <- mask1+mask2
  res <- res[mask12>0,]
  cat("  do cr plots 2b:",nrow(res),"\n")

  mask <- vector(mode="integer",length=nrow(res))
  mask1 <- mask;mask2 <- mask
  mask1[res$bmd1<10] <- 1
  mask2[res$bmd2<10] <- 1
  mask12 <- mask1+mask2
  res <- res[mask12>0,]
  cat("  do cr plots 3:",nrow(res),"\n")

  list1 <- paste0(res$sid1,"_",res$signature)
  list2 <- paste0(res$sid2,"_",res$signature)
  d1 <- as.data.frame(matrix(nrow=length(list1),ncol=2))
  d2 <- d1
  d1[,1] <- list1
  d2[,1] <- list2
  n <- length(list1)
  vals1 <- seq(from=1,to=n*2,by=2)
  vals1 <- vals1[1:n]
  vals2 <- vals1+1
  d1[,2] <- vals1
  d2[,2] <- vals2
  cat("  do cr plots 4\n")

  dmat <- rbind(d1,d2)
  dmat <- dmat[order(dmat[2]),]
  row.list <- dmat[,1]
  cat("  do cr plots 5:",length(row.list),"\n")

  mat <- MAT
  sid.list <- unique(c(res$sid1,res$sid2))
  mat <- mat[is.element(mat$sample_id,sid.list),]
  mat <- mat[is.element(mat$signature,res$signature),]
  cat("  do cr plots 6\n")

  rnames <- paste0(mat$sample_id,"_",mat$signature)
  cat("  do cr plots 7\n")

  rownames(mat) <- rnames
  cat("  do cr plots 8\n")

  mat1 <- mat[row.list,]
  cat(" number of rows:",nrow(mat1),"\n")

  mat1$proper_name <- mat1$name
  cat("  cycle through signatures (rows) and run signatureConcRespPlot\n")

  for(i in 1:nrow(mat1)){
    cat(i," out of ",nrow(mat1),"\n")
    signatureConcRespPlot(mat1[i,])
    if(!to.file) browser()
  }

  if(!to.file) browser()
  else dev.off()
}
